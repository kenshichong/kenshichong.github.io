
 <!DOCTYPE HTML>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  
    <title>写着玩-运行库 | Dung Beetle</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="kenshichong">
    

    
    <meta name="description" content="0x00 口胡继续坚持。。。
0x01 入口函数和程序初始化不管是在程序的开始还是程序的结束，main既不是最初被调用的，也不是最后被调用的，在main之前或之后，还可以有很多事情我们可以做，我们可以插入我们想要执行的代码。
操作系统在创建进程后，把控制权交到了程序的入口，这个入口往往是运行库中的某个入口函数。
举个例子：

GLIBC入口函数glibc的启动过程在不同的情况下差别很大，比如静态的">
<meta property="og:type" content="article">
<meta property="og:title" content="写着玩-运行库">
<meta property="og:url" content="http://kenshichong.github.io/2016/05/09/写着玩-运行库/index.html">
<meta property="og:site_name" content="Dung Beetle">
<meta property="og:description" content="0x00 口胡继续坚持。。。
0x01 入口函数和程序初始化不管是在程序的开始还是程序的结束，main既不是最初被调用的，也不是最后被调用的，在main之前或之后，还可以有很多事情我们可以做，我们可以插入我们想要执行的代码。
操作系统在创建进程后，把控制权交到了程序的入口，这个入口往往是运行库中的某个入口函数。
举个例子：

GLIBC入口函数glibc的启动过程在不同的情况下差别很大，比如静态的">
<meta property="og:image" content="http://kenshichong.github.io/img/写着玩-运行库/0.PNG">
<meta property="og:image" content="http://kenshichong.github.io/img/写着玩-运行库/1.PNG">
<meta property="og:image" content="http://kenshichong.github.io/img/写着玩-运行库/2.PNG">
<meta property="og:image" content="http://kenshichong.github.io/img/写着玩-运行库/3.PNG">
<meta property="og:image" content="http://kenshichong.github.io/img/写着玩-运行库/4.PNG">
<meta property="og:image" content="http://kenshichong.github.io/img/写着玩-运行库/5.PNG">
<meta property="og:image" content="http://kenshichong.github.io/img/写着玩-运行库/6.PNG">
<meta property="og:image" content="http://kenshichong.github.io/img/写着玩-运行库/7.PNG">
<meta property="og:image" content="http://kenshichong.github.io/img/写着玩-运行库/8.PNG">
<meta property="og:image" content="http://kenshichong.github.io/img/写着玩-运行库/9.PNG">
<meta property="og:image" content="http://kenshichong.github.io/img/写着玩-运行库/10.PNG">
<meta property="og:image" content="http://kenshichong.github.io/img/写着玩-运行库/11.PNG">
<meta property="og:image" content="http://kenshichong.github.io/img/写着玩-运行库/12.PNG">
<meta property="og:image" content="http://kenshichong.github.io/img/写着玩-运行库/13.PNG">
<meta property="og:image" content="http://kenshichong.github.io/img/写着玩-运行库/14.PNG">
<meta property="og:image" content="http://kenshichong.github.io/img/写着玩-运行库/15.PNG">
<meta property="og:image" content="http://kenshichong.github.io/img/写着玩-运行库/16.PNG">
<meta property="og:image" content="http://kenshichong.github.io/img/写着玩-运行库/17.PNG">
<meta property="og:image" content="http://kenshichong.github.io/img/写着玩-运行库/20.PNG">
<meta property="og:image" content="http://kenshichong.github.io/img/写着玩-运行库/18.PNG">
<meta property="og:image" content="http://kenshichong.github.io/img/写着玩-运行库/19.PNG">
<meta property="og:image" content="http://kenshichong.github.io/img/写着玩-运行库/21.PNG">
<meta property="og:image" content="http://kenshichong.github.io/img/写着玩-运行库/22.PNG">
<meta property="og:image" content="http://kenshichong.github.io/img/写着玩-运行库/23.PNG">
<meta property="og:image" content="http://kenshichong.github.io/img/写着玩-运行库/24.PNG">
<meta property="og:image" content="http://kenshichong.github.io/img/写着玩-运行库/25.PNG">
<meta property="og:image" content="http://kenshichong.github.io/img/写着玩-运行库/26.PNG">
<meta property="og:image" content="http://kenshichong.github.io/img/写着玩-运行库/27.PNG">
<meta property="og:image" content="http://kenshichong.github.io/img/写着玩-运行库/28.PNG">
<meta property="og:image" content="http://kenshichong.github.io/img/写着玩-运行库/29.PNG">
<meta property="og:image" content="http://kenshichong.github.io/img/写着玩-运行库/30.PNG">
<meta property="og:image" content="http://kenshichong.github.io/img/写着玩-运行库/31.PNG">
<meta property="og:image" content="http://kenshichong.github.io/img/写着玩-运行库/32.PNG">
<meta property="og:image" content="http://kenshichong.github.io/img/写着玩-运行库/33.PNG">
<meta property="og:image" content="http://kenshichong.github.io/img/写着玩-运行库/34.PNG">
<meta property="og:image" content="http://kenshichong.github.io/img/写着玩-运行库/35.PNG">
<meta property="og:image" content="http://kenshichong.github.io/img/写着玩-运行库/36.PNG">
<meta property="og:image" content="http://kenshichong.github.io/img/写着玩-运行库/37.PNG">
<meta property="og:image" content="http://kenshichong.github.io/img/写着玩-运行库/38.PNG">
<meta property="og:image" content="http://kenshichong.github.io/img/写着玩-运行库/39.PNG">
<meta property="og:image" content="http://kenshichong.github.io/img/写着玩-运行库/40.PNG">
<meta property="og:image" content="http://kenshichong.github.io/img/写着玩-运行库/41.PNG">
<meta property="og:image" content="http://kenshichong.github.io/img/写着玩-运行库/42.PNG">
<meta property="og:image" content="http://kenshichong.github.io/img/写着玩-运行库/43.PNG">
<meta property="og:image" content="http://kenshichong.github.io/img/写着玩-运行库/44.PNG">
<meta property="og:image" content="http://kenshichong.github.io/img/写着玩-运行库/45.PNG">
<meta property="og:image" content="http://kenshichong.github.io/img/写着玩-运行库/46.PNG">
<meta property="og:image" content="http://kenshichong.github.io/img/写着玩-运行库/47.PNG">
<meta property="og:image" content="http://kenshichong.github.io/img/写着玩-运行库/48.PNG">
<meta property="og:image" content="http://kenshichong.github.io/img/写着玩-运行库/49.PNG">
<meta property="og:image" content="http://kenshichong.github.io/img/写着玩-运行库/50.PNG">
<meta property="og:image" content="http://kenshichong.github.io/img/写着玩-运行库/51.PNG">
<meta property="og:image" content="http://kenshichong.github.io/img/写着玩-运行库/52.PNG">
<meta property="og:image" content="http://kenshichong.github.io/img/写着玩-运行库/53.PNG">
<meta property="og:image" content="http://kenshichong.github.io/img/写着玩-运行库/54.PNG">
<meta property="og:image" content="http://kenshichong.github.io/img/写着玩-运行库/55.PNG">
<meta property="og:image" content="http://kenshichong.github.io/img/写着玩-运行库/56.PNG">
<meta property="og:image" content="http://kenshichong.github.io/img/写着玩-运行库/57.PNG">
<meta property="og:image" content="http://kenshichong.github.io/img/写着玩-运行库/58.PNG">
<meta property="og:image" content="http://kenshichong.github.io/img/写着玩-运行库/59.PNG">
<meta property="og:image" content="http://kenshichong.github.io/img/写着玩-运行库/60.PNG">
<meta property="og:image" content="http://kenshichong.github.io/img/写着玩-运行库/61.PNG">
<meta property="og:image" content="http://kenshichong.github.io/img/写着玩-运行库/62.PNG">
<meta property="og:image" content="http://kenshichong.github.io/img/写着玩-运行库/63.PNG">
<meta property="og:image" content="http://kenshichong.github.io/img/写着玩-运行库/64.PNG">
<meta property="og:image" content="http://kenshichong.github.io/img/写着玩-运行库/65.PNG">
<meta property="og:image" content="http://kenshichong.github.io/img/写着玩-运行库/66.PNG">
<meta property="og:image" content="http://kenshichong.github.io/img/写着玩-运行库/67.PNG">
<meta property="og:image" content="http://kenshichong.github.io/img/写着玩-运行库/68.PNG">
<meta property="og:image" content="http://kenshichong.github.io/img/写着玩-运行库/69.PNG">
<meta property="og:image" content="http://kenshichong.github.io/img/写着玩-运行库/70.PNG">
<meta property="og:image" content="http://kenshichong.github.io/img/写着玩-运行库/71.PNG">
<meta property="og:image" content="http://kenshichong.github.io/img/写着玩-运行库/72.PNG">
<meta property="og:image" content="http://kenshichong.github.io/img/写着玩-运行库/73.PNG">
<meta property="og:image" content="http://kenshichong.github.io/img/写着玩-运行库/74.PNG">
<meta property="og:image" content="http://kenshichong.github.io/img/写着玩-运行库/75.PNG">
<meta property="og:image" content="http://kenshichong.github.io/img/写着玩-运行库/76.PNG">
<meta property="og:image" content="http://kenshichong.github.io/img/写着玩-运行库/77.PNG">
<meta property="og:image" content="http://kenshichong.github.io/img/写着玩-运行库/78.PNG">
<meta property="og:image" content="http://kenshichong.github.io/img/写着玩-运行库/79.PNG">
<meta property="og:image" content="http://kenshichong.github.io/img/写着玩-运行库/80.PNG">
<meta property="og:image" content="http://kenshichong.github.io/img/写着玩-运行库/81.PNG">
<meta property="og:image" content="http://kenshichong.github.io/img/写着玩-运行库/82.PNG">
<meta property="og:image" content="http://kenshichong.github.io/img/写着玩-运行库/83.PNG">
<meta property="og:image" content="http://kenshichong.github.io/img/写着玩-运行库/84.PNG">
<meta property="og:image" content="http://kenshichong.github.io/img/写着玩-运行库/85.PNG">
<meta property="og:image" content="http://kenshichong.github.io/img/写着玩-运行库/86.PNG">
<meta property="og:image" content="http://kenshichong.github.io/img/写着玩-运行库/87.PNG">
<meta property="og:image" content="http://kenshichong.github.io/img/写着玩-运行库/88.PNG">
<meta property="og:image" content="http://kenshichong.github.io/img/写着玩-运行库/89.PNG">
<meta property="og:image" content="http://kenshichong.github.io/img/写着玩-运行库/90.PNG">
<meta property="og:image" content="http://kenshichong.github.io/img/写着玩-运行库/91.PNG">
<meta property="og:image" content="http://kenshichong.github.io/img/写着玩-运行库/92.PNG">
<meta property="og:image" content="http://kenshichong.github.io/img/写着玩-运行库/93.PNG">
<meta property="og:image" content="http://kenshichong.github.io/img/写着玩-运行库/94.PNG">
<meta property="og:image" content="http://kenshichong.github.io/img/写着玩-运行库/95.PNG">
<meta property="og:image" content="http://kenshichong.github.io/img/写着玩-运行库/96.PNG">
<meta property="og:image" content="http://kenshichong.github.io/img/写着玩-运行库/97.PNG">
<meta property="og:image" content="http://kenshichong.github.io/img/写着玩-运行库/98.PNG">
<meta property="og:image" content="http://kenshichong.github.io/img/写着玩-运行库/99.PNG">
<meta property="og:image" content="http://kenshichong.github.io/img/写着玩-运行库/100.PNG">
<meta property="og:image" content="http://kenshichong.github.io/img/写着玩-运行库/101.PNG">
<meta property="og:image" content="http://kenshichong.github.io/img/写着玩-运行库/102.PNG">
<meta property="og:image" content="http://kenshichong.github.io/img/写着玩-运行库/103.PNG">
<meta property="og:image" content="http://kenshichong.github.io/img/写着玩-运行库/104.PNG">
<meta property="og:image" content="http://kenshichong.github.io/img/写着玩-运行库/105.PNG">
<meta property="og:image" content="http://kenshichong.github.io/img/写着玩-运行库/106.PNG">
<meta property="og:image" content="http://kenshichong.github.io/img/写着玩-运行库/107.PNG">
<meta property="og:image" content="http://kenshichong.github.io/img/写着玩-运行库/107.PNG">
<meta property="og:image" content="http://kenshichong.github.io/img/写着玩-运行库/108.PNG">
<meta property="og:image" content="http://kenshichong.github.io/img/写着玩-运行库/109.PNG">
<meta property="og:image" content="http://kenshichong.github.io/img/写着玩-运行库/110.PNG">
<meta property="og:image" content="http://kenshichong.github.io/img/写着玩-运行库/111.PNG">
<meta property="og:image" content="http://kenshichong.github.io/img/写着玩-运行库/112.PNG">
<meta property="og:image" content="http://kenshichong.github.io/img/写着玩-运行库/113.PNG">
<meta property="og:image" content="http://kenshichong.github.io/img/写着玩-运行库/114.PNG">
<meta property="og:updated_time" content="2016-05-11T03:28:56.241Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="写着玩-运行库">
<meta name="twitter:description" content="0x00 口胡继续坚持。。。
0x01 入口函数和程序初始化不管是在程序的开始还是程序的结束，main既不是最初被调用的，也不是最后被调用的，在main之前或之后，还可以有很多事情我们可以做，我们可以插入我们想要执行的代码。
操作系统在创建进程后，把控制权交到了程序的入口，这个入口往往是运行库中的某个入口函数。
举个例子：

GLIBC入口函数glibc的启动过程在不同的情况下差别很大，比如静态的">

    
    <link rel="alternative" href="/atom.xml" title="Dung Beetle" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/jacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/jacman.jpg">
    
    <link rel="stylesheet" href="/css/style.css" type="text/css">
</head>

  <body>
    <header>
      
<div>
		
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="Dung Beetle">Dung Beetle</a></h1>
				<h2 class="blog-motto">Be a machine</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜单">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">Home</a></li>
					
						<li><a href="/archives">Archives</a></li>
					
						<li><a href="/about">About</a></li>
					
					<li>
 					
					<form class="search" action="//google.com/search" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="search" id="search" name="q" autocomplete="off" maxlength="20" placeholder="搜索" />
						<input type="hidden" name="q" value="site:kenshichong.github.io">
					</form>
					
					</li>
				</ul>
			</nav>			
</div>
    </header>
    <div id="container">
      <div id="main" class="post" itemscope itemprop="blogPost">
  
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/05/09/写着玩-运行库/" title="写着玩-运行库" itemprop="url">写着玩-运行库</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="kenshichong" target="_blank" itemprop="author">kenshichong</a>
		
  <p class="article-time">
    <time datetime="2016-05-09T00:38:03.000Z" itemprop="datePublished"> 发表于 2016-05-09</time>
    
  </p>
</header>
	<div class="article-content">
		
		<div id="toc" class="toc-article">
			<strong class="toc-title">文章目录</strong>
		
			<ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#0x00_口胡"><span class="toc-number">1.</span> <span class="toc-text">0x00 口胡</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x01_入口函数和程序初始化"><span class="toc-number">2.</span> <span class="toc-text">0x01 入口函数和程序初始化</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#GLIBC入口函数"><span class="toc-number">2.1.</span> <span class="toc-text">GLIBC入口函数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MSVC_CRT入口函数"><span class="toc-number">2.2.</span> <span class="toc-text">MSVC CRT入口函数</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x02_运行库与I/O"><span class="toc-number">3.</span> <span class="toc-text">0x02 运行库与I/O</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x03_C语言运行库"><span class="toc-number">4.</span> <span class="toc-text">0x03 C语言运行库</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#变长参数"><span class="toc-number">4.1.</span> <span class="toc-text">变长参数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#非局部跳转"><span class="toc-number">4.2.</span> <span class="toc-text">非局部跳转</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#glibc"><span class="toc-number">4.3.</span> <span class="toc-text">glibc</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#glibc启动文件"><span class="toc-number">4.4.</span> <span class="toc-text">glibc启动文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#取消默认的启动文件和C语言运行库"><span class="toc-number">4.5.</span> <span class="toc-text">取消默认的启动文件和C语言运行库</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#GCC平台相关目标文件"><span class="toc-number">4.6.</span> <span class="toc-text">GCC平台相关目标文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MSVC_CRT"><span class="toc-number">4.7.</span> <span class="toc-text">MSVC CRT</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#运行库与多线程"><span class="toc-number">4.8.</span> <span class="toc-text">运行库与多线程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#TLS实现"><span class="toc-number">4.9.</span> <span class="toc-text">TLS实现</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x04_C++全局构造和析构"><span class="toc-number">5.</span> <span class="toc-text">0x04 C++全局构造和析构</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#glibc全局构造和析构"><span class="toc-number">5.1.</span> <span class="toc-text">glibc全局构造和析构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#析构"><span class="toc-number">5.2.</span> <span class="toc-text">析构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MSVC_CRT的全局构造和析构"><span class="toc-number">5.3.</span> <span class="toc-text">MSVC CRT的全局构造和析构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MSVC_CRT析构"><span class="toc-number">5.4.</span> <span class="toc-text">MSVC CRT析构</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x05_fread实现"><span class="toc-number">6.</span> <span class="toc-text">0x05 fread实现</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#缓冲"><span class="toc-number">6.1.</span> <span class="toc-text">缓冲</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#fread_s"><span class="toc-number">6.2.</span> <span class="toc-text">fread_s</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#_read()"><span class="toc-number">6.3.</span> <span class="toc-text">_read()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#fread_流程总结"><span class="toc-number">6.4.</span> <span class="toc-text">fread 流程总结</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x06_结"><span class="toc-number">7.</span> <span class="toc-text">0x06 结</span></a></li></ol>
		
		</div>
		
		<h1 id="0x00_口胡">0x00 口胡</h1><p>继续坚持。。。</p>
<h1 id="0x01_入口函数和程序初始化">0x01 入口函数和程序初始化</h1><p>不管是在程序的开始还是程序的结束，main既不是最初被调用的，也不是最后被调用的，在main之前或之后，还可以有很多事情我们可以做，我们可以插入我们想要执行的代码。</p>
<p>操作系统在创建进程后，把控制权交到了程序的入口，这个入口往往是运行库中的某个入口函数。</p>
<p>举个例子：</p>
<p><img src="/img/写着玩-运行库/0.PNG" alt=""></p>
<h2 id="GLIBC入口函数">GLIBC入口函数</h2><p>glibc的启动过程在不同的情况下差别很大，比如静态的glibc和动态的glibc的差别，glibc用于可执行文件和用于共享库的差别，可以组合4种情况。下面关于Glibc和MSVCCRT的相关代码分析在不额外说明的情况下，都默认为静态/可执行文件链接的情况。其他情况自行举一反三</p>
<p><img src="/img/写着玩-运行库/1.PNG" alt=""></p>
<p>在介绍这段代码之前，我们首先要知道栈的布局是什么样的。</p>
<p>在前面我们介绍过，进程刚开始启动的时候，须知道一些进程运行的环境，最基本的就是系统环境变量和进程的运行参数。这些信息是需要在进程启动之前就需要提前给进程准备好的，一种常见的做法就是操作系统在进程启动前将这些信息提前保存到进程的虚拟空间的栈中(也就是VMA中的Stack VMA)。</p>
<p><img src="/img/写着玩-运行库/2.PNG" alt=""><br><img src="/img/写着玩-运行库/3.PNG" alt=""><br><img src="/img/写着玩-运行库/4.PNG" alt=""></p>
<p>这里我们谈运行库，也就是说在glibc的start执行之前的栈结构就已经被初始化成了这个样子。</p>
<p>接下来看start：</p>
<p><img src="/img/写着玩-运行库/5.PNG" alt=""><br><img src="/img/写着玩-运行库/6.PNG" alt=""></p>
<p>环境变量：</p>
<p><img src="/img/写着玩-运行库/7.PNG" alt=""></p>
<p>start后时__libc_start_main:</p>
<p><img src="/img/写着玩-运行库/8.PNG" alt=""><br><img src="/img/写着玩-运行库/9.PNG" alt=""></p>
<p>对于<strong>libc_start_main中的</strong>BOUNDED_POINTERS__宏定义的说明：</p>
<p><img src="/img/写着玩-运行库/10.PNG" alt=""></p>
<p>接着看：</p>
<p><img src="/img/写着玩-运行库/11.PNG" alt=""><br><img src="/img/写着玩-运行库/12.PNG" alt=""><br><img src="/img/写着玩-运行库/13.PNG" alt=""><br><img src="/img/写着玩-运行库/14.PNG" alt=""></p>
<p>对于hlt指令的说明：</p>
<p><img src="/img/写着玩-运行库/15.PNG" alt=""></p>
<p>总结下，就是start开始，传入7个参数调用<strong>libc_start_main，在</strong>libc_start_main中，对各个参数进行解析，并将参数赋予一些具有具体意义的变量，以便后面使用；然后是调用一系列函数，在这些函数中，其中一个就是将main之后需要调用的函数提前注册一下，然后就是main了，main之后，调用exit，在exit中，会遍历链表，将上面注册的需要在面之后调用的函数调用，然后调用_exit()，_exit()中就是exit的系统调用，然后正常退出。</p>
<h2 id="MSVC_CRT入口函数">MSVC CRT入口函数</h2><p>MSVC的CRT默认的入口函数名为mainCRTStartup:</p>
<p><img src="/img/写着玩-运行库/16.PNG" alt=""><br><img src="/img/写着玩-运行库/17.PNG" alt=""></p>
<p>对于alloca的说明：<br><img src="/img/写着玩-运行库/20.PNG" alt=""></p>
<p>接着说：<br><img src="/img/写着玩-运行库/18.PNG" alt=""><br><img src="/img/写着玩-运行库/19.PNG" alt=""></p>
<p>总结下，这个mainCRTStartup的总体流程就是：</p>
<ol>
<li>初始化和OS版本有关的全局变量</li>
<li>初始化堆</li>
<li>初始化I/O</li>
<li>获取命令行参数和环境变量</li>
<li>初始化C库的一些数据</li>
<li>调用main并记录返回值</li>
<li>检查错误并将main的返回值返回</li>
</ol>
<h1 id="0x02_运行库与I/O">0x02 运行库与I/O</h1><p>一个程序的I/O指代了程序与外界的交互，包括文件、管道、网络、命令行、信号等。更广义地讲，I/O指代任何操作系统理解为“文件”的事务。在操作系统层面上，文件操作也有类似于FILE的一个概念，在linux里，这叫做文件描述符(fd)，而在Windows里，叫做句柄(handle)</p>
<p><img src="/img/写着玩-运行库/21.PNG" alt=""></p>
<p>给出FILE、fd、打开文件表和打开文件对象的关系图：<br><img src="/img/写着玩-运行库/22.PNG" alt=""></p>
<p>图中，内核指针p指向该进程的打开文件表，所以只要有fd，就可以用fd+p来得到打开文件表的某一项地址。stdin、stdout、stderr均是FILE结构的指针。</p>
<p>对于Windows的句柄，与linux的fd大同小异，不过Windows的句柄并不是打开文件表的下标，而是其下标经过某种线性变换之后的结果(如果变换是线性的话，可以通过多打开几个文件，来求解这种线性转换关系)。</p>
<p>所谓的I/O初始化，指I/O初始化函数需要在用户空间中建立stdin、stdout、stderr及其对应的FILE结构，使得程序进入main之后就可以直接使用printf、scanf等函数。</p>
<p>前面我们提到了MSVC CRT的入口函数，其中涉及到初始化部分。</p>
<p><strong>对于堆的初始化：</strong></p>
<p><img src="/img/写着玩-运行库/23.PNG" alt=""></p>
<p>可以看出，MSVC的堆初始化过程异常简单，仅仅调用了HeapCreate这个函数创建了一个系统堆。因此不难推测，MSVC的malloc函数必然调用HeapAlloc这个API，将堆管理的过程直接交给了操作系统。</p>
<p><strong>对于I/O初始化：</strong><br>我们先从总体上把握下I/O的初始化，MSVC的I/O初始化主要进行了如下几个工作：</p>
<ol>
<li>建立打开文件表。</li>
<li>如果能够继承自父进程，那么从父进程获取继承的句柄。</li>
<li>初始化标准输入输出。</li>
</ol>
<p>下面一个个来解释：<br>首先，每个进程都有一个自己的打开文件表，I/O初始化就是对这个打开文件表的初始化。</p>
<p><img src="/img/写着玩-运行库/24.PNG" alt=""></p>
<p>在初始化开始部分，会先声明一个数组，对应于图中的ioinfo * __pioinfo[64]，这是一个指针数组，共有64个ioinfo结构的指针，这64个指针又分别指向ioinfo数组，书中说，每个数组的大小是32个ioinfo结构，所以这相当于一个二维数组。这里使用指针数组的原因是指针数组可以根据需要来去动态的申请空间，而不像二维数组那样，一上来就搞了64x32的大小，浪费。</p>
<p>这个指针数组毫无疑问就是打开文件表了，它的成员是ioinfo结构，给出这个结构体的定义：</p>
<p><img src="/img/写着玩-运行库/25.PNG" alt=""><br><img src="/img/写着玩-运行库/26.PNG" alt=""></p>
<p>MSVC的I/O初始化就是要构造这个二维的打开文件表。构造过程是在I/O初始化函数_ioinit中，该函数定义于crt/src/ioinit.c中。</p>
<p>首先，_ioinit函数初始化了__pioinfo数组的第一个二级数组：</p>
<p><img src="/img/写着玩-运行库/27.PNG" alt=""></p>
<p>在这里_ioinit初始化了的__pioinfo[0]里的每一个元素为无效值，只起到一个占位的作用，其中INVALID_HANDLE_VALUE是Windows句柄的无效值，值为-1.</p>
<p>接下来，_ioinit的工作就是将一些预定义的打开文件给初始化，这包括两部分：</p>
<p><img src="/img/写着玩-运行库/28.PNG" alt=""></p>
<p>上图中说到，对于打开文件表的初始化，如果有继承自父进程的打开文件句柄，则需要把继承的句柄给填到自己的打开文件表中。如何获得从父进程继承的打开文件句柄呢？</p>
<p>可以使用API GetStartupInfo来获取继承的打开文件，GetStartInfo的参数如下：</p>
<p><img src="/img/写着玩-运行库/29.PNG" alt=""><br><img src="/img/写着玩-运行库/30.PNG" alt=""></p>
<p>有了GetStartupInfo结构以后，再根据上面的介绍，我们就可以得到继承的句柄了。而_ioinit函数也正是这么做的：</p>
<p><img src="/img/写着玩-运行库/31.PNG" alt=""></p>
<p>有了继承的句柄，下面就要往自己的打开文件表里填充了。</p>
<p>在填充之前，先是判断了一下直接的打开的文件表是否足以容纳所有的句柄：</p>
<p><img src="/img/写着玩-运行库/32.PNG" alt=""></p>
<p>然后要给打开文件表分配足够的空间以容纳所有的句柄：</p>
<p><img src="/img/写着玩-运行库/33.PNG" alt=""></p>
<p>可以看出，新分配的都是填入的无效数据，起到占位的作用。分配过后，填充就很容易了。</p>
<p><img src="/img/写着玩-运行库/34.PNG" alt=""><br><img src="/img/写着玩-运行库/35.PNG" alt=""><br><img src="/img/写着玩-运行库/36.PNG" alt=""></p>
<p>到这，I/O初始化算是真正完成了，所有的I/O函数都可以自由使用了。</p>
<p>我们知道，我们进行I/O操作时，都是把我们要进行I/O操作的对象当做文件来处理的，借由一系列的文件函数来达到I/O的效果。文件函数操作的是一种被称作FILE的结构。我们来看FILE结构和I/O的关系：</p>
<p>给出FILE结构定义：</p>
<p><img src="/img/写着玩-运行库/37.PNG" alt=""></p>
<p>图中说到通过_file字段可以访问到内部文件句柄表中的对应项，而通过前面的介绍，我们知道句柄值存储在ioinfo的osfhnd字段中且只有拿到句柄才能对相应的文件对象进行操作。</p>
<p>假设现在我们通过fopen()函数得到了一个FILE结构的指针，我们看下如何系统是如何通过这个FILE结构找到相应的句柄并进行文件操作的：</p>
<p>我们知道，句柄值(osfhnd)所在的ioinfo结构是处在__pioinfo这个二维数组中的，FILE结构中的_file的值，和此表的两个下标直接相关联。</p>
<p><img src="/img/写着玩-运行库/38.PNG" alt=""></p>
<p>这样，我们就知道FILE和句柄的对应关系了，有了句柄就可以进行操作了。</p>
<p>入口函数最重要的两部分-堆初始化和I/O初始化已经在上面谈到了。但是，入口函数只是冰山一角，它隶属的是一个庞大的代码集合，这个代码集合叫做运行库。</p>
<h1 id="0x03_C语言运行库">0x03 C语言运行库</h1><p>C程序的运行，都需要C运行库(CRT)的支持。C语言运行库是一个庞大的代码集合，不管是VS中的VC/srt/src还是linux下的libc，都是大的要命，啃不动。</p>
<p>一个C语言运行库大致包含了如下功能：</p>
<ol>
<li>启动与退出：包括入口函数及入口函数所依赖的其他函数等</li>
<li>标准函数：由C语言标准规定的C语言标准库所拥有的函数实现</li>
<li>I/O：I/O功能的封装和实现</li>
<li>堆：堆的封装和实现</li>
<li>语言实现：语言中一些特殊功能的实现</li>
<li>调试：实现调试功能的代码</li>
</ol>
<p>运行库的组成成分中，C语言标准库占据了主要地位。C语言标准库是C语言标准化的基础函数库，我们平时使用的printf、exit等都是标准库的一部分。标准库中定义了C语言中普遍存在的函数集合，我们可以放心的使用标准库中规定的函数而不用担心在将代码移植到别的平台时对应的平台上不提供这个函数。也就是说，只要支持C语言(常见的OS都是支持C的，很多都是C写的)，那么这些函数就可以正常运行。</p>
<p>ANSI C的标准库由24个C头文件组成，与许多其他语言(如java)的标准库不同，C语言的标准库非常轻量，仅仅包含数学函数、字符/字符串处理，I/O等基本方面。</p>
<p><img src="/img/写着玩-运行库/39.PNG" alt=""><br><img src="/img/写着玩-运行库/40.PNG" alt=""></p>
<p>基本的就不介绍了，下面介绍下上面提到的变长参数和非局部跳转：</p>
<h2 id="变长参数">变长参数</h2><p>变长参数的一个典型例子就是printf()，那么标准库中，在这种允许变长参数的函数内部是怎样去访问这些变长参数的呢？是使用几个宏-va_list、va_start()、va_arg():</p>
<p><img src="/img/写着玩-运行库/41.PNG" alt=""></p>
<p>变长参数的实现原理：<br>支持变长参数的C标准库函数一般调用方式都是cdecl的，变长参数的实现得益于C语言默认的cdecl调用惯例的自右向左压栈传递方式。</p>
<p>其实我们完全可以自己实现变长参数的支持，举个例子：<br>设想如下函数：</p>
<p>int sum(unsigned num,…);</p>
<p><img src="/img/写着玩-运行库/42.PNG" alt=""></p>
<p>这里，需要注意：</p>
<p><img src="/img/写着玩-运行库/43.PNG" alt=""></p>
<p>对于printf狂乱输出的问题，了解printf的，应该都知道用不好printf所带来的危险性。</p>
<p>回到前面说的va_list等宏的实现问题上，理所当然的很简单：</p>
<p><img src="/img/写着玩-运行库/44.PNG" alt=""></p>
<p>小扩展：变长参数宏的实现：</p>
<p><img src="/img/写着玩-运行库/45.PNG" alt=""><br><img src="/img/写着玩-运行库/46.PNG" alt=""></p>
<h2 id="非局部跳转">非局部跳转</h2><p>这绝对是黑科技！！！</p>
<p><img src="/img/写着玩-运行库/47.PNG" alt=""></p>
<p>C语言运行库从某种程度上来讲是C语言的程序和不同操作系统平台之间的抽象层，它将不同的操作系统API抽象成相同的库函数。比如我们可以在不同的操作系统平台下使用fread来读取文件，而事实上fread在不同的操作系统平台下的实现是不同的，但作为运行库的使用者我们不需要关心这一点。</p>
<p>linux和Windows平台下的两个主要C语言运行库分别为glibc(GNU C Library)和 MSVCRT(Microsoft Visual C Run-time).</p>
<p><img src="/img/写着玩-运行库/48.PNG" alt=""></p>
<h2 id="glibc">glibc</h2><p>glibc的历史就不说了，没jb意思。事实上glibc出了C标准库之外，还有几个辅助程序运行的运行库，这几个文件可以称得上是真正的”运行库”，他们是/usr/lib/crt1.o、/usr/lib/crti.o、/usr/lib/crtn.o</p>
<h2 id="glibc启动文件">glibc启动文件</h2><p>crt1.o里面包含的就是程序的入口函数_start。</p>
<p>对于crti.o和crtn.o，这两个目标文件中包含的代码实际上是_init()函数和_finit()函数的开始和结尾部分，当这两个文件和其他目标文件顺序链接起来以后，刚好形成两个完整的函数_init()和_finit()。给出这两个文件的反汇编代码：</p>
<p><img src="/img/写着玩-运行库/49.PNG" alt=""><br><img src="/img/写着玩-运行库/50.PNG" alt=""><br><img src="/img/写着玩-运行库/51.PNG" alt=""></p>
<p>我们在前面提到过，crt1.o包含_start，在_start中，会调用<strong>libc_start_main()，在调用时，它向该函数传递了两个函数指针”</strong>libc_csu_init”和”__libc_csu_fini”，这两个函数负责调用_init()和_finit()，主要用于在main()函数之前执行的全局/静态对象构造和必须在main()函数之后执行的全局/静态对象析构。</p>
<p><img src="/img/写着玩-运行库/52.PNG" alt=""></p>
<h2 id="取消默认的启动文件和C语言运行库">取消默认的启动文件和C语言运行库</h2><p><img src="/img/写着玩-运行库/53.PNG" alt=""></p>
<h2 id="GCC平台相关目标文件">GCC平台相关目标文件</h2><p><img src="/img/写着玩-运行库/54.PNG" alt=""></p>
<h2 id="MSVC_CRT">MSVC CRT</h2><p>书上只是介绍了运行库的版本问题，以及如何通过命名方法来识别某个库支持什么。</p>
<p><img src="/img/写着玩-运行库/55.PNG" alt=""></p>
<p>上图中所列的都是C语言的标准库，MSVC还提供了相应的C++标准库</p>
<p><img src="/img/写着玩-运行库/56.PNG" alt=""></p>
<p>如果程序是用C++编写的，那么就需要额外链接相应的C++标准库，这里额外的有意思是，上图中的C++标准库里面包含的仅仅是C++的内容。当你在程序里包含了某个C++标准库的头文件时，MSVC编译器就认为该源代码文件是一个C++源代码程序</p>
<p>关于MSVC CRT的介绍，总之就是版本很多很复杂，用的时候要小心，其他就没有什么有营养的东西。</p>
<p><img src="/img/写着玩-运行库/57.PNG" alt=""></p>
<h2 id="运行库与多线程">运行库与多线程</h2><p>上面也说了，CRT是有单线程和多线程之分的，现有版本的C/C++标准是不支持多线程的，但主流的CRT都是有相应的多线程的功能的。</p>
<p>C语言运行库必须支持多线程环境。我们知道由于线程的切换和线程对于进程内存的所有数据都有访问权限的特性，就会由于在线程切换时由于访问进程内的同一资源而出现很多想不到的错误。由于多线程的普及，CRT为了支持多线程，解决这些错误，也是做了一些改进，包括使用TLS(线程局部存储)、加锁、改进函数调用方式。这些改进的核心原理就是在线程切换时，我们想要保护的线程共享数据是受到保护的。</p>
<h2 id="TLS实现">TLS实现</h2><p><img src="/img/写着玩-运行库/58.PNG" alt=""><br><img src="/img/写着玩-运行库/59.PNG" alt=""><br><img src="/img/写着玩-运行库/60.PNG" alt=""><br><img src="/img/写着玩-运行库/61.PNG" alt=""><br><img src="/img/写着玩-运行库/62.PNG" alt=""><br><img src="/img/写着玩-运行库/63.PNG" alt=""><br><img src="/img/写着玩-运行库/64.PNG" alt=""><br><img src="/img/写着玩-运行库/65.PNG" alt=""><br><img src="/img/写着玩-运行库/66.PNG" alt=""><br><img src="/img/写着玩-运行库/67.PNG" alt=""></p>
<h1 id="0x04_C++全局构造和析构">0x04 C++全局构造和析构</h1><h2 id="glibc全局构造和析构">glibc全局构造和析构</h2><p>我们在前面介绍start的时候，对于他的7个参数只是简单的列举了下，并没有详细介绍，这里详细介绍下。</p>
<p>_start-&gt;<strong>libc_start_main，_start在调用</strong>libc_start_main的时候是传递了7个参数的，其中传递的init函数指针指向的是__libc_csu_init函数，位于Glibc源代码目录的csu/ELF-init.c，给出：</p>
<p><img src="/img/写着玩-运行库/68.PNG" alt=""></p>
<p>可以看出，调用了_init()函数，前面我们谈到过crti.o的_init()函数，这里__libc_csu_init里面调用的正是”.init”段，也就是说”.init”段中的代码就将在这里被执行。我们随意反汇编一个可执行文件的.init段：</p>
<p><img src="/img/写着玩-运行库/69.PNG" alt=""><br><img src="/img/写着玩-运行库/70.PNG" alt=""></p>
<p>上面这段代码首先将<strong>CTOR_LIST</strong>数组的第一个元素当做数组元素的个数，然后将第一个元素之后的元素都当做是函数指针，并一一调用。很明显，<strong>CTOR_LIST</strong>里面存放的就是所有全局对象的构造函数的指针，那么接下来就开始研究<strong>CTOR_LIST</strong>这个数组了。</p>
<p>为了研究这个数组，我们给出一个示例代码：</p>
<p><img src="/img/写着玩-运行库/71.PNG" alt=""></p>
<p>对于每个编译单元(.cpp)，GCC编译器会遍历其中所有的全局对象，生成一个名为_GLOBAL__I_Hw的函数，由这个函数负责本编译单元的所有的全局/静态对象的构造和析构，它的代码可以表示为：</p>
<p><img src="/img/写着玩-运行库/72.PNG" alt=""></p>
<p>先不管<strong>tcf_1这个函数。对于每个编译单元，如果它有全局/静态对象，那么他会生成GLOBAL</strong>I_Hw这样的函数，然后他会在这个编译单元产生的目标文件(.o)的”.ctors”段里放置一个指针，这个指针就指向这个函数。</p>
<p>链接器在链接这些目标文件时，会将同名的段合并在一起，那么，理所当然的，每个目标文件的.ctors段将会被合并为一个.ctors段，其中的内容是各个目标文件的.ctors段的内存拼接而成。由于每个目标文件的.cors段都只存储了一个指针，指向那个用于构造和析构的函数，那么拼起来的.ctors段就是一个函数指针数组。</p>
<p>但是这个地址的数组现在是不可知的，这个数组的地址只有在链接(静态链接)的时候才能够真正确定下来，链接器是知道这个地址的，那么链接器是如何把它知道的这个关键地址告诉程序的呢？很简单，将这个地址存到某个地方不就行了，程序需要用到的时候就去这个地方取就行了。思想就是这么个思想，我们来看具体实现。</p>
<p>还记得在链接的时候，各个用户产生的目标文件的前后分别还要链接上一个crtbegin.o和crtend.o吗？这两个glibc自身的目标文件同样具有.ctors    段，在链接的时候，这两个文件的.ctors段的内容也会被合并到最终的可执行文件中。</p>
<p><img src="/img/写着玩-运行库/73.PNG" alt=""></p>
<p>解释下上图，链接器会将crtbegin.o中的.ctors段的起始地址定义成符号<strong>CTOR_LIST</strong>，这个符号是在最终链接形成的目标文件的符号段中是可以找到的，所以访问<strong>CTOR_LIST</strong>这个变量就可以得到这个数组的地址了。由于crtbegin.o中的.ctors位置的特殊性(总是第一个被合并)，因此其起始地址就是所有.ctor段最终合并后的起始地址了。</p>
<p><img src="/img/写着玩-运行库/74.PNG" alt=""></p>
<p>总结下，全局构造的实现，首先是在链接过程中，合并.ctors段得到最终的可执行文件中的.ctors段(就是一个全局构造函数指针数组)，然后将这个指针数组的起始地址记录在变量(符号)<strong>CTOR_LIST</strong>中，链接完成，得到可执行文件。可执行文件执行，按照_start -&gt; <strong>libc_start_main -&gt; </strong>libc_csu_init -&gt; _init -&gt; <strong>do_global_ctors_aux的执行顺序来执行上述函数，而在</strong>do_global_ctors_aux函数中，直接访问变量(符号)<strong>CTOR_LIST</strong>来得到全局构造函数指针，从而一个个执行构造函数，完成全局构造。</p>
<p><strong>在main前调用函数</strong><br>知道的main前调用有:</p>
<ol>
<li>TLS回调</li>
<li>.init段添加代码</li>
<li>.ctors段添加函数指针</li>
</ol>
<p><img src="/img/写着玩-运行库/75.PNG" alt=""></p>
<h2 id="析构">析构</h2><p>讲完了构造，析构已经很显然了，无非就是在main执行后采用完全相反的顺序来执行析构了，早期的glibc和GCC确实是这样做的：</p>
<p><img src="/img/写着玩-运行库/76.PNG" alt=""><br><img src="/img/写着玩-运行库/77.PNG" alt=""></p>
<p>现在采用的做法是类似的，编译的时候每个编译单元的全局/静态对象会生成一个函数，这个函数有两个作用，一是执行构造函数，而是用at_exit把其相应的析构函数给注册一下，我们知道at_exit注册的函数会在main执行后的exit中被调用，而且满足先注册后调用的机制，所以很自然的被用于析构的实现。</p>
<p><img src="/img/写着玩-运行库/78.PNG" alt=""><br><img src="/img/写着玩-运行库/79.PNG" alt=""></p>
<h2 id="MSVC_CRT的全局构造和析构">MSVC CRT的全局构造和析构</h2><p><img src="/img/写着玩-运行库/80.PNG" alt=""><br><img src="/img/写着玩-运行库/81.PNG" alt=""><br><img src="/img/写着玩-运行库/82.PNG" alt=""><br><img src="/img/写着玩-运行库/83.PNG" alt=""></p>
<p>总结下，MSVC CRT的全局构造的大体实现机制与Glibc相似，在MSVC CRT中，在形成可执行文件时，两个全局变量<strong>xc_a和</strong>xc_z就被链接器初始化为数组的起始和结束地址，然后执行时，mainCRTStartup -&gt; _inittern，在_inittern中，被循环遍历，执行全局构造。</p>
<p><strong>在MSVC中同样可以修改段来得到main之前执行的权限</strong></p>
<p><img src="/img/写着玩-运行库/84.PNG" alt=""></p>
<h2 id="MSVC_CRT析构">MSVC CRT析构</h2><p>与glibc几乎相同：</p>
<p><img src="/img/写着玩-运行库/85.PNG" alt=""><br><img src="/img/写着玩-运行库/86.PNG" alt=""></p>
<h1 id="0x05_fread实现">0x05 fread实现</h1><p>通过解析fread，进一步深入I/O</p>
<p>给出fread的函数声明：</p>
<p><img src="/img/写着玩-运行库/87.PNG" alt=""></p>
<p>我们知道，fread最终是通过Windows的系统API-ReadFile来实现对文件的读取的。给出ReadFile的函数声明：</p>
<p><img src="/img/写着玩-运行库/88.PNG" alt=""></p>
<p>可以看出他们在功能上看似完全相同，而且参数几乎一一对应。</p>
<p>我们来看fread到ReadFile的中间到底干了什么。</p>
<p>对于glibc，fread的实现过于复杂，因此这里选择MSVC的fread实现。</p>
<h2 id="缓冲">缓冲</h2><p>提到文件操作，就不得不介绍缓冲，它是一种机制：</p>
<p><img src="/img/写着玩-运行库/89.PNG" alt=""></p>
<p>由于真正去操作文件是一件对OS来说非常费劲的事，所以要使用缓冲。当要读取数据的时候，首先看看这个文件的缓冲里有没有数据，如果有数据就直接从缓冲中取。如果缓冲是空的，那么CRT就通过操作系统一次性读取文件一块较大的内容填充缓冲，这样，如果每次读取文件都是一些尺寸很小的数据，那么这些读取操作大多都直接从缓冲中获得，可以避免大量的实际文件访问。</p>
<p>C语言标准库提供了几个与缓冲相关的基本函数，都是熟人：</p>
<p><img src="/img/写着玩-运行库/90.PNG" alt=""></p>
<h2 id="fread_s">fread_s</h2><p>fread定义在crt/fread.c中，实际内容只有一行：</p>
<p><img src="/img/写着玩-运行库/91.PNG" alt=""><br><img src="/img/写着玩-运行库/92.PNG" alt=""><br><img src="/img/写着玩-运行库/93.PNG" alt=""><br><img src="/img/写着玩-运行库/94.PNG" alt=""><br><img src="/img/写着玩-运行库/95.PNG" alt=""><br><img src="/img/写着玩-运行库/96.PNG" alt=""></p>
<p>可以看出，文件的缓冲是在FILE结构中指出的，有缓冲的话，就会直接从文件缓冲中进行read，这里要把文件缓冲和buf分开。</p>
<p><img src="/img/写着玩-运行库/97.PNG" alt=""></p>
<p>是否使用文件缓冲以及使用文件缓冲的类型是在flag字段中记录的，下面的anybuf宏check是否使用文件缓冲也是根据flag中的这三个标志位来check的。</p>
<p><img src="/img/写着玩-运行库/98.PNG" alt=""></p>
<p>到这里，仅仅是确定了是否有文件缓冲，然后准备读数据，但此时还没有读，这里要分清两个读的过程，即从文件缓冲中读，读到最终的目的地buffer中和从真正的文件中读，读到文件缓冲中。此时，这两个读都没有发生，具体怎样读，分三种情况：</p>
<ol>
<li><p><img src="/img/写着玩-运行库/99.PNG" alt=""><br><img src="/img/写着玩-运行库/100.PNG" alt=""></p>
</li>
</ol>
<p>什么意思呢，就是有文件缓冲，并且缓冲不为空，就是说缓冲中有数据，则直接从文件缓冲中读数据读到最终目的地buffer中。</p>
<p>其中，nbytes代表这次要从文件缓冲中读取多少字节，在这里，nbytes等于还需要读取的字节数(count)与缓冲中剩余数据的字节数(stream -&gt; _cnt)中较小的一个。接下来的一行使用memcpy_s将文件缓冲里ptr所指向的缓冲内容复制到data指向的最终目的地buffer中。接下来的5行就是更新FILE结构和局部变量由于这次操作而改变后的数据。</p>
<p><img src="/img/写着玩-运行库/101.PNG" alt=""></p>
<ol>
<li>上面的1是缓冲不为空时的操作，当缓冲为空时(缓冲为空有两种可能，第一种是缓冲不为空，但读的数据大于缓冲的大小，直接通过1之后把缓冲读空了；第二种情况是虽然有缓冲，但缓冲本来就是空的)，又分为两种情况：</li>
</ol>
<p><img src="/img/写着玩-运行库/102.PNG" alt=""></p>
<p>对于情况1：</p>
<p><img src="/img/写着玩-运行库/103.PNG" alt=""></p>
<p>从文件中读整数个文件缓冲大小的数据(向上取整，在上面也可以看到这个读取的过程是一个while的循环过程，直到count(count是我们给定的我们想要从文件中读取的数据的大小)为0退出循环)，也就是说这种情况下，每次都会读取文件缓冲大小的数据，而且不经过缓冲，直接从文件中读数据，然后把数据填到最终目的地buffer中，直到剩余的count的大小小于文件缓冲的尺寸，然后会执行情况2的代码：</p>
<p>对于情况2，即要读取的数据不大于缓冲的尺寸，那么仅需要重新填充缓冲即可：</p>
<p><img src="/img/写着玩-运行库/104.PNG" alt=""></p>
<p>反正到最后缓冲剩余的数据大小是&gt;=0的。</p>
<p>可以看出。不管是哪种情况，只要是从文件中读数据，都是使用的同一个函数，那就是_read()函数。</p>
<h2 id="_read()">_read()</h2><p>_read函数主要负责两件事：</p>
<ol>
<li>从文件读取数据</li>
<li>对文本模式打开的文件，转换回车符。</li>
</ol>
<p><img src="/img/写着玩-运行库/105.PNG" alt=""><br><img src="/img/写着玩-运行库/106.PNG" alt=""><br><img src="/img/写着玩-运行库/107.PNG" alt=""></p>
<p>可以看出，_read就是封装了ReadFile，将真正的文件数据读到该读的地方去(文件缓冲或最终目的地buffer中)，最后对返回值进行检查。</p>
<p>这样，fread的流程就算分析完了。</p>
<p>这里，还有一个遗漏，就是处理换行符的问题，上面提到的单字节缓冲就是用于处理换行的。我们知道ReadFile可以对管道或设备进行处理，前提是管道或设备以文本模式打开。</p>
<p><img src="/img/写着玩-运行库/107.PNG" alt=""><br><img src="/img/写着玩-运行库/108.PNG" alt=""><br><img src="/img/写着玩-运行库/109.PNG" alt=""><br><img src="/img/写着玩-运行库/110.PNG" alt=""><br><img src="/img/写着玩-运行库/111.PNG" alt=""><br><img src="/img/写着玩-运行库/112.PNG" alt=""><br><img src="/img/写着玩-运行库/113.PNG" alt=""></p>
<h2 id="fread_流程总结">fread 流程总结</h2><p><img src="/img/写着玩-运行库/114.PNG" alt=""></p>
<h1 id="0x06_结">0x06 结</h1><ol>
<li>入口函数</li>
<li>I/O初始化</li>
<li>文件缓冲</li>
</ol>
  
	</div>
		<footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/reverse-related/">reverse related</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/人丑就要多读书/">人丑就要多读书</a>
  </div>

</div>



	<div class="article-share" id="share">
	
	  <div data-url="http://kenshichong.github.io/2016/05/09/写着玩-运行库/" data-title="写着玩-运行库 | Dung Beetle" data-tsina="null" class="share clearfix">
	  </div>
	
	</div>


</footer>

   	       
	</article>
	
<nav class="article-nav clearfix">
 
 <div class="prev" >
 <a href="/2016/05/11/写着玩-系统调用与API/" title="写着玩-系统调用与API">
  <strong>上一篇：</strong><br/>
  <span>
  写着玩-系统调用与API</span>
</a>
</div>


<div class="next">
<a href="/2016/05/08/写着玩-窥视内存/"  title="写着玩-窥视内存">
 <strong>下一篇：</strong><br/> 
 <span>写着玩-窥视内存
</span>
</a>
</div>

</nav>

	

</div>  
      <div class="openaside"><a class="navbutton" href="#" title="显示侧边栏"></a></div>

  <div id="toc" class="toc-aside">
  <strong class="toc-title">文章目录</strong>
 
 <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#0x00_口胡"><span class="toc-number">1.</span> <span class="toc-text">0x00 口胡</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x01_入口函数和程序初始化"><span class="toc-number">2.</span> <span class="toc-text">0x01 入口函数和程序初始化</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#GLIBC入口函数"><span class="toc-number">2.1.</span> <span class="toc-text">GLIBC入口函数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MSVC_CRT入口函数"><span class="toc-number">2.2.</span> <span class="toc-text">MSVC CRT入口函数</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x02_运行库与I/O"><span class="toc-number">3.</span> <span class="toc-text">0x02 运行库与I/O</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x03_C语言运行库"><span class="toc-number">4.</span> <span class="toc-text">0x03 C语言运行库</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#变长参数"><span class="toc-number">4.1.</span> <span class="toc-text">变长参数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#非局部跳转"><span class="toc-number">4.2.</span> <span class="toc-text">非局部跳转</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#glibc"><span class="toc-number">4.3.</span> <span class="toc-text">glibc</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#glibc启动文件"><span class="toc-number">4.4.</span> <span class="toc-text">glibc启动文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#取消默认的启动文件和C语言运行库"><span class="toc-number">4.5.</span> <span class="toc-text">取消默认的启动文件和C语言运行库</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#GCC平台相关目标文件"><span class="toc-number">4.6.</span> <span class="toc-text">GCC平台相关目标文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MSVC_CRT"><span class="toc-number">4.7.</span> <span class="toc-text">MSVC CRT</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#运行库与多线程"><span class="toc-number">4.8.</span> <span class="toc-text">运行库与多线程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#TLS实现"><span class="toc-number">4.9.</span> <span class="toc-text">TLS实现</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x04_C++全局构造和析构"><span class="toc-number">5.</span> <span class="toc-text">0x04 C++全局构造和析构</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#glibc全局构造和析构"><span class="toc-number">5.1.</span> <span class="toc-text">glibc全局构造和析构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#析构"><span class="toc-number">5.2.</span> <span class="toc-text">析构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MSVC_CRT的全局构造和析构"><span class="toc-number">5.3.</span> <span class="toc-text">MSVC CRT的全局构造和析构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MSVC_CRT析构"><span class="toc-number">5.4.</span> <span class="toc-text">MSVC CRT析构</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x05_fread实现"><span class="toc-number">6.</span> <span class="toc-text">0x05 fread实现</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#缓冲"><span class="toc-number">6.1.</span> <span class="toc-text">缓冲</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#fread_s"><span class="toc-number">6.2.</span> <span class="toc-text">fread_s</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#_read()"><span class="toc-number">6.3.</span> <span class="toc-text">_read()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#fread_流程总结"><span class="toc-number">6.4.</span> <span class="toc-text">fread 流程总结</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x06_结"><span class="toc-number">7.</span> <span class="toc-text">0x06 结</span></a></li></ol>
 
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隐藏侧边栏"></a></div>
<aside class="clearfix">

  


  
<div class="categorieslist">
	<p class="asidetitle">分类</p>
		<ul>
		
		  
			<li><a href="/categories/cryptography/" title="cryptography">cryptography<sup>12</sup></a></li>
		  
		
		  
			<li><a href="/categories/reverse-related/" title="reverse related">reverse related<sup>17</sup></a></li>
		  
		
		  
			<li><a href="/categories/think-for-fun/" title="think for fun">think for fun<sup>1</sup></a></li>
		  
		
		</ul>
</div>


  
<div class="tagslist">
	<p class="asidetitle">标签</p>
		<ul class="clearfix">
		
			
				<li><a href="/tags/人丑就要多读书/" title="人丑就要多读书">人丑就要多读书<sup>12</sup></a></li>
			
		
			
				<li><a href="/tags/密码学/" title="密码学">密码学<sup>12</sup></a></li>
			
		
			
				<li><a href="/tags/操作系统/" title="操作系统">操作系统<sup>3</sup></a></li>
			
		
			
				<li><a href="/tags/随想/" title="随想">随想<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/源码说明一切/" title="源码说明一切">源码说明一切<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/编译原理/" title="编译原理">编译原理<sup>1</sup></a></li>
			
		
		</ul>
</div>


  <div class="linkslist">
  <p class="asidetitle">友情链接</p>
    <ul>
        
          <li>
            
            	<a href="https://coderq.com" target="_blank" title="一个面向程序员交流分享的新一代社区">码农圈</a>
            
          </li>
        
          <li>
            
            	<a href="http://www.lynahex.com" target="_blank" title="lynahex&#39;s Blog">lynahex&#39;s Blog</a>
            
          </li>
        
          <li>
            
            	<a href="http://hear7v.githup.io" target="_blank" title="Hear7v&#39;s Blog">Hear7v&#39;s Blog</a>
            
          </li>
        
    </ul>
</div>

  


  <div class="rsspart">
	<a href="/atom.xml" target="_blank" title="rss">RSS 订阅</a>
</div>

  <div class="weiboshow">
  <p class="asidetitle">新浪微博</p>
    <iframe width="100%" height="119" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=119&fansRow=2&ptype=1&speed=0&skin=9&isTitle=1&noborder=1&isWeibo=0&isFans=0&uid=null&verifier=&dpc=1"></iframe>
</div>


</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<section class="info">
		<p> People I care, technology <br/>
			Dota, Anime and Nothing....</p>
	</section>
	 
	<div class="social-font" class="clearfix">
		
		
		
		
		
		
		
		
		
		
	</div>
			
		

		<p class="copyright">
		Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/wuchong/jacman" target="_blank" title="Jacman">Jacman</a> © 2016 
		
		<a href="/about" target="_blank" title="kenshichong">kenshichong</a>
		
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/jquery.qrcode-0.12.0.min.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  c.click(function(){
    ta.css('display', 'block').addClass('fadeIn');
  });
  o.click(function(){
    ta.css('display', 'none');
  });
  $(window).scroll(function(){
    ta.css("top",Math.max(140,320-$(this).scrollTop()));
  });
});
</script>


<script type="text/javascript">
$(document).ready(function(){ 
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina'),
      description = $this.attr('description');
  var html = [
  '<div class="hoverqrcode clearfix"></div>',
  '<a class="overlay" id="qrcode"></a>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="微信"></a>',
  '<a href="http://widget.renren.com/dialog/share?resourceUrl=' + encodedUrl + '&srcUrl=' + encodedUrl + '&title=' + title +'" class="article-share-renren" target="_blank" title="人人"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="微博"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);

  $('.hoverqrcode').hide();

  var myWidth = 0;
  function updatehoverqrcode(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
    var qrsize = myWidth > 1024 ? 200:100;
    var options = {render: 'image', size: qrsize, fill: '#2ca6cb', text: url, radius: 0.5, quiet: 1};
    var p = $('.article-share-qrcode').position();
    $('.hoverqrcode').empty().css('width', qrsize).css('height', qrsize)
                          .css('left', p.left-qrsize/2+20).css('top', p.top-qrsize-10)
                          .qrcode(options);
  };
  $(window).resize(function(){
    $('.hoverqrcode').hide();
  });
  $('.article-share-qrcode').click(function(){
    updatehoverqrcode();
    $('.hoverqrcode').toggle();
  });
  $('.article-share-qrcode').hover(function(){}, function(){
      $('.hoverqrcode').hide();
  });
});   
</script>









<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



<!-- Analytics Begin -->



<script type="text/javascript">
var _bdhmProtocol = (("https:" == document.location.protocol) ? " https://" : " http://");
document.write(unescape("%3Cscript src='" + _bdhmProtocol + "hm.baidu.com/h.js%3Fe6d1f421bbc9962127a50488f9ed37d1' type='text/javascript'%3E%3C/script%3E"));
</script>



<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="返回顶部"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<!-- Tiny_search End -->

  </body>
</html>
